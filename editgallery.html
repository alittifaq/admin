<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Gallery</title>
    <link rel="stylesheet" href="galleryform.css" />
  </head>
  <body>
    <div id="container">
      <div id="formWrapper">
        <div id="inputfile">
          <h2>Update Image</h2>
          <div id="fileInputWrapper">
            <input type="file" id="imageInput" accept="image/*" capture />
            <button onclick="uploadImage()">Upload Image</button>
          </div>
        </div>
        <form id="edit-gallery-Form">
          <table>
            <tr>
              <td><input type="hidden" id="gallery-id" name="gallery-id" /></td>
            </tr>
            <tr>
              <td><label for="gallery-photo">Foto:</label></td>
              <td>
                <input
                  type="text"
                  id="gallery-photo"
                  name="gallery-photo"
                  required
                />
              </td>
            </tr>
            <tr>
              <td><label for="judul_kegiatan">Judul Kegiatan:</label></td>
              <td>
                <input
                  type="text"
                  id="judul_kegiatan"
                  name="judul_kegiatan"
                  required
                />
              </td>
            </tr>
            <tr>
              <td><label for="tahun">Tahun:</label></td>
              <td>
                <input type="number" id="tahun" name="tahun" required />
              </td>
            </tr>
            <tr>
              <td colspan="2" class="center">
                <button type="submit">Update Gallery</button>
              </td>
            </tr>
          </table>
        </form>
      </div>
    </div>
    <div id="content"></div>
    <script type="module" src="./index.js"></script>
    <script type="module">
      async function editGalleryItem(galleryTitle) {
        try {
          const response = await fetch(
            `https://asia-southeast2-blkkalittifaq-426014.cloudfunctions.net/blkkalittifaq/data/gallery/detail?nama=${galleryTitle}`
          );

          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          const galleryItem = await response.json();

          // Populate form fields with product data
          document.getElementById("gallery-id").value = gallery._id;
          document.getElementById("judul_kegiatan").value =
            gallery.judul_kegiatan;
          document.getElementById("gallery-photo").value = gallery.foto;
          document.getElementById("tahun").value = gallery.tahun;
        } catch (error) {
          console.error("Error loading product data:", error);
        }
      }

      async function submitEditGallery(galleryId) {
        const editData = {
          _id: galleryId,
          foto: document.getElementById("gallery-photo").value,
          judul_kegiatan: document.getElementById("judul_kegiatan").value,
          tahun: document.getElementById("tahun").value,
        };

        try {
          const response = await fetch(
            `https://asia-southeast2-blkkalittifaq-426014.cloudfunctions.net/blkkalittifaq/data/gallery`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(editData),
            }
          );

          if (!response.ok) {
            throw new Error("Network response was not ok");
          }

          const data = await response.json();
          console.log("Edit Success:", data);
          alert("Gallery berhasil diedit!");
          window.location.href = "index.html"; // Redirect back to the product list
        } catch (error) {
          console.error("Fetch error:", error);
          alert("Edit gallery tidak berhasil.");
        }
      }

      document.addEventListener("DOMContentLoaded", async function () {
        const urlParams = new URLSearchParams(window.location.search);
        const galleryTitle = urlParams.get("judul_kegiatan");

        if (!galleryTitle) {
          console.error("No gallery title found in URL");
          return;
        }

        await editGalleryItem(galleryTitle);

        document
          .getElementById("edit-gallery-form")
          .addEventListener("submit", async function (event) {
            event.preventDefault();

            const galleryId = document.getElementById("gallery-id").value;
            await submitEditGallery(galleryId);
          });
      });
    </script>
  </body>
</html>
